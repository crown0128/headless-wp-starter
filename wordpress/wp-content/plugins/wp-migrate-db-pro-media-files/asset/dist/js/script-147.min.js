var wpmdb=wpmdb||{};wpmdb.mediaFiles={remote_media_files_unavailable:!1},function(a,b){function c(e){if(0===Object.size(e.files_to_migrate))return delete e.files_to_migrate,delete e.total_size,b.common.next_step_in_migration={fn:b.functions.finalise_media_migration,args:[e]},void b.functions.execute_next_step();var f=[],g=0,h=0;return a.each(e.files_to_migrate,function(a,c){if("push"===wpmdb_migration_type()&&c>k){var d=wpmdbmf_strings.file_too_large+" "+a+" (#124mf)<br>";b.common.non_fatal_errors+=d}else if(f.length){if(g+c>e.bottleneck||h>=b.mediaFiles.remote_connection_data.media_files_max_file_uploads)return!1;f.push(a),g+=c}else f.push(a),g+=c;delete e.files_to_migrate[a],++e.media_progress_image_number,++h}),b.common.migration_error?void b.functions.migration_complete_events():f.length?void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_migrate_media",migration_state_id:b.migration_state_id,file_chunk:f,nonce:wpmdb_data.nonces.migrate_media},error:function(a,c,d){b.current_migration.setState(wpmdbmf_strings.migration_failed,wpmdbGetAjaxErrors(wpmdbmf_strings.migration_failed,"(#102mf)",a.responseText,a),"error"),console.log(a),console.log(c),console.log(d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var h=f;if(f=wpmdb_parse_json(a.trim(f)),!f)return void d(h);if("undefined"!=typeof f.wpmdb_error&&1===f.wpmdb_error)return void d(f.body);if("undefined"!=typeof f.wpmdb_non_fatal_error&&1===f.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=f.body),f.transfers&&f.transfers.length){var i=0;a.each(f.transfers,function(a,c){setTimeout(function(){b.current_migration.model.getStageModel("media").setItemComplete(c.file)},i),i+=50})}e.media_progress+=g,b.common.next_step_in_migration={fn:c,args:[e]},b.functions.execute_next_step()}}):(b.common.next_step_in_migration={fn:c,args:[e]},void b.functions.execute_next_step())}function d(a){b.current_migration.setState(wpmdbmf_strings.migration_failed,wpmdbGetAjaxErrors("","",a),"error"),b.common.migration_error=!0,b.functions.migration_complete_events()}function e(){return!("1"!==a("#media-files").attr("data-available")||!a("#media-files").is(":checked"))}function f(b,c){return"savefile"!==wpmdb_migration_type()&&a("#media-files").is(":checked")&&"true"===wpmdb_data.is_multisite&&m.is(":checked")&&null===a("#mf-selected-subsites").val()&&(alert(wpmdbmf_strings.please_select_a_subsite),b=!1),b}function g(){var b=a('input[name="media_migration_option"][value="compare-remove"]');a(b).is(":checked")?a(".compare-remove-warning").show():a(".compare-remove-warning").hide()}function h(){var a={};return"pull"===wpmdb_migration_type()?"undefined"!=typeof b.mediaFiles.remote_connection_data&&"undefined"!=typeof b.mediaFiles.remote_connection_data.subsites&&(a=b.mediaFiles.remote_connection_data.subsites):void 0!==wpmdb_data.subsites&&(a=wpmdb_data.subsites),a}function i(){var c=a(".mf-selected-subsites-tables-differ"),d=a("#mf-selected-subsites").val(),e=a.wpmdb.apply_filters("wpmdb_get_tables_to_migrate",null,null);if("true"===wpmdb_data.is_multisite&&m.is(":checked")&&void 0!==d&&null!==d&&void 0!==e&&null!==e&&0<e.length){var f=a.wpmdb.apply_filters("wpmdb_get_table_prefix",null,null),g=!1;a.each(e,function(c,e){if(b.table_is(f,"posts",e)||b.table_is(f,"postmeta",e)){var h=b.subsite_for_table(f,e);if(0>a.inArray(h.toString(),d))return g=!0,!1}}),g?c.show():c.hide()}else c.hide()}function j(a){!0===e()&&"savefile"!==wpmdb_migration_type()&&b.current_migration.model.addStage("media",[],a.dataType,{strings:{itemsName:wpmdb_strings.files}})}var k=0,l=a("#mf-select-subsites-section"),m=a("#mf-select-subsites");Object.size||(Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;g<d;g++)a.call(e,c[g])&&h.push(c[g]);return h}}());var n=function(){a("#media-files").attr("data-available","0"),a("#media-files").prop("checked",!1),a("#media-files").attr("disabled","disabled"),a(".media-files").addClass("disabled"),a(".media-files-options .expandable-content").hide()},o=function(c){var d=wpmdb_migration_type();if(-1!==a.inArray(d,["savefile","find_replace"]))return void a(".media-files-options").hide();if(a(".media-files-options").show(),a(".media-files-push").hide(),c)return a(".media-files-options ul").hide(),a(".media-migration-unavailable").show(),void n();if("undefined"!=typeof b.mediaFiles.remote_connection_data&&wpmdb_data.media_files_version!==b.mediaFiles.remote_connection_data.media_files_version)return a(".media-files-remote-location").html(b.mediaFiles.remote_connection_data.url),a(".media-file-remote-version").html(b.mediaFiles.remote_connection_data.media_files_version),a(".media-files-different-plugin-version-notice").show(),void n();if("true"===wpmdb_data.is_multisite){var e=h(),f=a("#_mf-selected-subsites"),g=a("#mf-selected-subsites").val();"pull"===d&&0<Object.size(e)&&f.length&&(g=a.parseJSON(f.val()),f.remove()),b.multisite.update_multiselect("#mf-selected-subsites",e,g);var j=a.wpmdb.apply_filters("wpmdbmf_enable_select_subsites",!0);j?l.show():(m.prop("checked",!1),l.hide()),m.change(),i()}a(".media-files-options ul").show(),a(".media-migration-unavailable").hide(),a(".media-files-different-plugin-version-notice").hide(),a("#media-files").removeAttr("disabled"),a(".media-files").removeClass("disabled"),a("#media-files").attr("data-available","1")};b.functions.prepare_remove_all_files=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var c=a('input[name="media_migration_option"]:checked').val();if(b.current_migration.model.setActiveStage("media"),"entire"===c){var d="removing_all_files_"+wpmdb_migration_type();b.current_migration.setText(wpmdbmf_strings[d]);var e={};e.remove_files=1,e.compare=0,e.offset=0,e.next_step_in_migration=b.functions.prepare_determine_media,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[e]},b.functions.execute_next_step()}else b.common.next_step_in_migration={fn:b.functions.prepare_determine_media},b.functions.execute_next_step()},b.functions.remove_files_recursive=function(c){if(0===c.remove_files)return void(!1!==c.next_step_in_migration?(b.common.next_step_in_migration={fn:c.next_step_in_migration},b.functions.execute_next_step()):wpmdb_call_next_hook());b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var e=c;a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_remove_files_recursive",migration_state_id:b.migration_state_id,compare:c.compare,offset:JSON.stringify(c.offset),nonce:wpmdb_data.nonces.remove_files_recursive},error:function(a,c,d){b.current_migration.setState(wpmdbmf_strings.migration_failed,wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",a.responseText,a),"error"),console.log(a),console.log(c),console.log(d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var g=f;return(c=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error?void d(c.body):("undefined"!=typeof c.wpmdb_non_fatal_error&&1===c.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=c.body),c.next_step_in_migration=e.next_step_in_migration,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[c]},void b.functions.execute_next_step()):void d(g)}})},b.functions.prepare_determine_media=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),k=0;var c=0,e=0,f=a('input[name="media_migration_option"]:checked').val();b.current_migration.setText("0% - "+wpmdbmf_strings.determining),"compare-remove"===f&&(f="compare",c=1),"entire"===f&&(e=1);var g={};a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_prepare_determine_media",migration_state_id:b.migration_state_id,nonce:wpmdb_data.nonces.prepare_determine_media},error:function(a,c,d){b.current_migration.setState(wpmdbmf_strings.migration_failed,wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",a.responseText,a),"error"),console.log(a),console.log(c),console.log(d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var h=f;return(g=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof g.wpmdb_error&&1===g.wpmdb_error?void d(g.body):(k=g.remote_max_upload_size,g.determine_progress=0,g.remove_local_media=c,g.copy_entire_media=e,b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[g]},void b.functions.execute_next_step()):void d(h)}})},b.functions.determine_media_to_migrate_recursive=function(c){return c.determine_progress>=c.attachment_count?(b.common.next_step_in_migration={fn:b.functions.media_successfully_determined,args:[c]},void b.functions.execute_next_step()):(b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_determine_media_to_migrate_recursive",migration_state_id:b.migration_state_id,determine_progress:c.determine_progress,attachment_count:c.attachment_count,remote_uploads_url:c.remote_uploads_url,remove_local_media:c.remove_local_media,copy_entire_media:c.copy_entire_media,blogs:c.blogs,attachment_batch_limit:c.attachment_batch_limit,nonce:wpmdb_data.nonces.determine_media_to_migrate_recursive},error:function(a,c,d){b.current_migration.setState(wpmdbmf_strings.migration_failed,wpmdbmf_strings.error_determining+" (#101mf)","error"),console.log(a),console.log(c),console.log(d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(e){var f=e;if(e=wpmdb_parse_json(a.trim(e)),!e)return void d(f);if("undefined"!=typeof e.wpmdb_error&&1===e.wpmdb_error)return void d(e.body);c.blogs=e.blogs,c.determine_progress=e.determine_progress,c.total_size=c.total_size||0,c.total_size+=e.total_size,c.files_to_migrate=c.files_to_migrate||{},_.each(e.files_to_migrate,function(a,d){c.files_to_migrate[d]=a,b.current_migration.model.addStageItem("media",d,parseInt(a/1024))}),b.current_migration.fixProgressStageWidthForScrollBar();var g=Math.min(100,100*c.determine_progress/c.attachment_count),h=Math.floor(g);a(".migration-progress-stage-container[data-stage=media]").addClass("determining-media"),a(".progress-bar",".stage-progress.media").width(g+"%"),b.current_migration.setText(h+"% - "+wpmdbmf_strings.determining),b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[c]},b.functions.execute_next_step()}}))},b.functions.media_successfully_determined=function(d){if("undefined"!=typeof d.wpmdb_error&&1===d.wpmdb_error)return b.common.non_fatal_errors+=data.body,b.common.next_step_in_migration={fn:wpmdb_call_next_hook},void b.functions.execute_next_step();d.media_progress=0,d.media_progress_image_number=0,d.bottleneck=wpmdb_data.max_request,d.files_to_migrate=d.files_to_migrate||{};var e="migrate_media_files_"+wpmdb_migration_type();b.current_migration.setText(wpmdbmf_strings[e]),a(".migration-progress-stage-container[data-stage=media]").removeClass("determining-media"),b.common.next_step_in_migration={fn:c,args:[d]},b.functions.execute_next_step()},b.functions.finalise_media_migration=function(a){if(1===a.remove_local_media){var c="removing_files_"+wpmdb_migration_type();return b.current_migration.setText(wpmdbmf_strings[c]),a={},a.remove_files=1,a.compare=1,a.offset="",a.next_step_in_migration=!1,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[a]},void b.functions.execute_next_step()}wpmdb_call_next_hook()},a(document).ready(function(){-1!==a.inArray(wpmdb_migration_type(),["savefile","find_replace"])&&a(".media-files-options").hide(),a.wpmdb.add_action("move_connection_info_box",function(){o(b.mediaFiles.remote_media_files_unavailable),wpmdb_toggle_migration_action_text()}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){b.mediaFiles.remote_connection_data=a,b.mediaFiles.remote_media_files_unavailable="undefined"==typeof a.media_files_available,o(b.mediaFiles.remote_media_files_unavailable)}),a.wpmdb.add_action("wpmdbmst_select_subsite_changed",function(){o(b.mediaFiles.remote_media_files_unavailable)}),a.wpmdb.add_filter("wpmdb_before_migration_complete_hooks",function(a){return!1===e()||"savefile"===wpmdb_migration_type()?a:(a.push(b.functions.prepare_remove_all_files),a)}),a("body").on("change","#mf-select-subsites",function(){a.wpmdb.do_action("wpmdbmf_selected_subsites_changed")}),a("body").on("change","#mf-selected-subsites",function(){a.wpmdb.do_action("wpmdbmf_selected_subsites_changed")}),a.wpmdb.add_filter("wpmdb_migration_profile_ready",f),a.wpmdb.add_action("wpmdb_tables_to_migrate_changed",i),a.wpmdb.add_action("wpmdbmf_selected_subsites_changed",i),a.wpmdb.add_action("wpmdb_add_migration_stages",j),a('input[name="media_migration_option"]').change(function(){g()}),g()})}(jQuery,wpmdb);